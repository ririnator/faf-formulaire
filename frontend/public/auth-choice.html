<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Bienvenue sur FAF - Form a Friend</title>
    <link rel="stylesheet" href="/css/shared-base.css" nonce="{{nonce}}">
    <link rel="stylesheet" href="/css/auth-choice.css" nonce="{{nonce}}">
</head>
<body>
    <div class="container">
        <h1>üé≠ FAF</h1>
        <p class="subtitle">Form a Friend - Cr√©ez des liens authentiques</p>

        <button id="loginBtn" class="auth-btn primary-btn" aria-describedby="login-desc">
            Se connecter
        </button>
        <span id="login-desc" class="sr-only">Connectez-vous avec votre compte existant</span>

        <button id="registerBtn" class="auth-btn secondary-btn" aria-describedby="register-desc">
            Cr√©er un compte
        </button>
        <span id="register-desc" class="sr-only">Inscrivez-vous pour cr√©er un nouveau compte</span>

        <div class="divider">
            <span>ou</span>
        </div>

        <button id="guestBtn" class="auth-btn guest-btn" aria-describedby="guest-desc">
            Continuer en mode invit√©
        </button>
        <span id="guest-desc" class="sr-only">Utiliser le formulaire sans cr√©er de compte, avec liens priv√©s</span>

        <p class="guest-description">
            Le mode invit√© utilise l'ancien syst√®me avec liens priv√©s
        </p>
    </div>

    <script nonce="{{nonce}}">
        function continueAsGuest() {
            // Mode legacy pour transition douce
            // Pas besoin de stockage client, utilisation cookie serveur
            window.location.href = '/form.html';
        }

        function redirectToLogin() {
            window.location.href = '/login';
        }

        function redirectToRegister() {
            window.location.href = '/register';
        }

        // Fonction pour v√©rifier l'authentification avec gestion d'erreurs am√©lior√©e
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include',
                    signal: AbortSignal.timeout(5000) // Timeout de 5 secondes
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.debug('Auth status checked successfully:', data);
                    return { authenticated: true, user: data };
                }
                
                // Gestion des erreurs HTTP sp√©cifiques
                if (response.status === 401) {
                    console.debug('User not authenticated (401) - this is normal for auth-choice page');
                    return { authenticated: false, reason: 'unauthorized' };
                }
                
                if (response.status === 403) {
                    console.warn('Access forbidden (403)');
                    return { authenticated: false, reason: 'forbidden' };
                }
                
                if (response.status >= 500) {
                    console.error('Server error during auth check:', response.status);
                    return { authenticated: false, reason: 'server_error', status: response.status };
                }
                
                // Autres erreurs client (4xx)
                console.warn('Auth check failed with status:', response.status);
                return { authenticated: false, reason: 'client_error', status: response.status };
                
            } catch (error) {
                // Gestion des erreurs r√©seau et autres
                if (error.name === 'TimeoutError' || error.name === 'AbortError') {
                    console.debug('Auth check timeout - proceeding with guest options');
                    return { authenticated: false, reason: 'timeout' };
                }
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    console.debug('Network error during auth check - proceeding with guest options');
                    return { authenticated: false, reason: 'network_error' };
                }
                
                // Erreur inconnue - ne pas bloquer l'utilisateur
                console.debug('Auth check failed, but allowing page to function:', error.message);
                return { authenticated: false, reason: 'unknown_error', error: error.message };
            }
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async function() {
            console.debug('Auth choice page loaded');
            
            // Attacher les event listeners aux boutons
            document.getElementById('loginBtn').addEventListener('click', redirectToLogin);
            document.getElementById('registerBtn').addEventListener('click', redirectToRegister);
            document.getElementById('guestBtn').addEventListener('click', continueAsGuest);
            
            // V√©rification optionnelle de l'authentification
            // Ne bloque pas le fonctionnement de la page si elle √©choue
            try {
                const authStatus = await checkAuthStatus();
                
                if (authStatus.authenticated) {
                    console.debug('User is already authenticated, could redirect to dashboard');
                    // Optionnel: rediriger vers le dashboard si l'utilisateur est d√©j√† connect√©
                    // window.location.href = '/admin/admin.html';
                } else {
                    console.debug('User not authenticated, showing auth options');
                }
            } catch (error) {
                console.debug('Auth check failed during page load, continuing normally:', error);
                // Continue avec les options d'authentification disponibles
            }
        });

        // Gestion des erreurs globales pour √©viter les alertes utilisateur
        window.addEventListener('unhandledrejection', function(event) {
            console.debug('Handled promise rejection in auth-choice:', event.reason);
            event.preventDefault(); // Emp√™che l'affichage d'erreurs √† l'utilisateur
        });

        window.addEventListener('error', function(event) {
            console.debug('Handled error in auth-choice:', event.error);
        });
    </script>
</body>
</html>