<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Form-a-Friend - Formulaire</title>
  <link rel="stylesheet" href="/admin/mobile-responsive.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 1.1rem;
    }

    .form-group {
      margin-bottom: 25px;
    }

    fieldset {
      border: none;
      margin-bottom: 25px;
    }

    legend {
      font-size: 1.2rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 15px;
      padding: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #4a5568;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f7fafc;
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .radio-group {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }

    .radio-group:hover {
      background-color: #f7fafc;
    }

    .radio-group input[type="radio"] {
      margin-right: 12px;
      transform: scale(1.2);
      accent-color: #667eea;
    }

    .radio-group label {
      margin: 0;
      cursor: pointer;
      flex: 1;
    }

    input[type="file"] {
      width: 100%;
      padding: 15px;
      border: 2px dashed #e2e8f0;
      border-radius: 10px;
      background: #f7fafc;
      font-size: 1rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: #667eea;
      background: #edf2f7;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #feedback {
      margin-top: 30px;
      padding: 20px;
      border-radius: 10px;
      font-size: 1rem;
      text-align: center;
    }

    #feedback.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    #feedback.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #feb2b2;
    }

    #feedback a {
      color: #3182ce;
      text-decoration: none;
      font-weight: 600;
    }

    #feedback a:hover {
      text-decoration: underline;
    }

    .form-icon {
      display: inline-block;
      margin-right: 8px;
      font-size: 1.2em;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.5s ease;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .radio-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .radio-group input[type="radio"] {
        margin-bottom: 5px;
      }
    }

    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #667eea;
      color: white;
      padding: 8px;
      border-radius: 4px;
      text-decoration: none;
      transition: top 0.3s;
    }

    .skip-link:focus {
      top: 6px;
    }
  </style>
</head>
<body>
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>
  
  <main id="main-content" role="main">
    <div class="container">
      <h1 id="form-title">üåü Formulaire Mensuel</h1>
      <p class="subtitle">Dis-moi tout ! Partage tes pens√©es et d√©couvre celles de tes amis</p>
      
      <!-- Barre de progression -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <form id="friendForm" role="form" aria-labelledby="form-title" novalidate>
      <!-- Honeypot field for spam protection -->
      <input type="text" name="website" style="display:none" tabindex="-1" autocomplete="off" aria-hidden="true">

    <!-- Champ Nom -->
    <div class="form-group">
      <label for="name"><span class="form-icon">üë§</span>Ton nom :</label>
      <input type="text" id="name" name="name" required 
             aria-describedby="name-help" 
             aria-invalid="false"
             autocomplete="name">
      <div id="name-help" class="sr-only">Entrez votre pr√©nom ou surnom</div>
    </div>

    <!-- Question 1 -->
    <fieldset class="form-group">
      <legend><span class="form-icon">üí≠</span>En rapide, comment √ßa va ? :</legend>
      <div class="radio-group">
        <input type="radio" name="question1" id="option1" value="√ßa va" required 
               aria-describedby="q1-help">
        <label for="option1">√ßa va</label>
      </div>
      <div class="radio-group">
        <input type="radio" name="question1" id="option2" value="a connu meilleur mois">
        <label for="option2" id="labelOption2"></label>
      </div>
      <div class="radio-group">
        <input type="radio" name="question1" id="option3" value="ITS JOEVER">
        <label for="option3">ITS JOEVER</label>
      </div>
      <div class="radio-group">
        <input type="radio" name="question1" id="option4" value="WE'RE BARACK">
        <label for="option4">WE'RE BARACK</label>
      </div>
    </fieldset>

    <!-- Question 2 -->
    <div class="form-group">
      <label for="question2"><span class="form-icon">üìù</span>Possibilit√© d'ajouter un peu plus de d√©tails √† la question pr√©c√©dente :</label>
      <input type="text" id="question2" name="question2" required
             aria-describedby="q2-help"
             aria-invalid="false"
             maxlength="10000"
             placeholder="D√©veloppez votre r√©ponse pr√©c√©dente...">

    <!-- Question 3 -->
    <div class="form-group">
      <label for="question3"><span class="form-icon">üì∏</span>Le pulse check mensuel... montre une photo de toi ce mois-ci :</label>
      <input type="file" id="question3" name="question3" accept="image/*" required
             aria-describedby="q3-help"
             aria-invalid="false">
      <div id="q3-help" class="sr-only">(formats accept√©s: JPG, PNG, GIF)</div>
    </div>

    <!-- Question 4 -->
    <div class="form-group">
      <label for="question4"><span class="form-icon">‚ú®</span>Est-ce que tu veux partager un truc cool que t'as fait ce mois-ci ? :</label>
      <textarea id="question4" name="question4" rows="3" required></textarea>
    </div>

    <!-- Question 5 -->
    <div class="form-group">
      <label for="question5"><span class="form-icon">üòä</span>C'est quoi la reaction pic que tu utilises le plus en ce moment ? :</label>
      <input type="file" id="question5" name="question5" accept="image/*" required>
    </div>

    <!-- Question 6 -->
    <div class="form-group">
      <label for="question6"><span class="form-icon">üí¨</span>Est-ce que t'as eu une conversation int√©ressante avec quelqu'un r√©cemment ? De quoi est-ce que √ßa parlait ? :</label>
      <textarea id="question6" name="question6" rows="3" required></textarea>
    </div>

    <!-- Question 7 -->
    <div class="form-group">
      <label for="question7"><span class="form-icon">üé≠</span>Ta d√©couverte culturelle du moment ? (film, s√©rie, resto, bar, zoo, belle femme, v√™tement... une cat√©gorie assez libre finalement) :</label>
      <input type="file" id="question7" name="question7" accept="image/*" required>
    </div>

    <!-- Question 8 -->
    <div class="form-group">
      <label for="question8"><span class="form-icon">üîÑ</span>Est-ce que t'as une habitude ou une nouvelle routine que t'essaies d'impl√©menter ces temps-ci ? Si oui... est-ce que √ßa fonctionne... si non... est-ce que y'a un truc que tu voudrais impl√©menter ? :</label>
      <textarea id="question8" name="question8" rows="3" required></textarea>
    </div>

    <!-- Question 9 -->
    <div class="form-group">
      <label for="question9"><span class="form-icon">üÜò</span>Appel √† un AMI : Est-ce que t'as un probl√®me particulier pour lequel tu aurais besoin d'opinions tierces ? (exemple : poll pour ta prochaine teinture, recommandations de matelas, etc.) :</label>
      <textarea id="question9" name="question9" rows="3" required></textarea>
    </div>

    <!-- Question 10 -->
    <div class="form-group">
      <label for="question10"><span class="form-icon">üåø</span>Pour terminer : une photo de toi qui touche de l'herbe ou un arbre :</label>
      <input type="file" id="question10" name="question10" accept="image/*" required>
    </div>

    <button type="submit" 
            aria-describedby="submit-help"
            class="btn-submit">
      Envoyer le formulaire
    </button>
    <div id="submit-help" class="sr-only">
      
      Soumettre vos r√©ponses mensuelles. Un lien priv√© vous sera fourni pour consulter vos r√©ponses.
    </div>
      </form>

      <!-- Section de feedback -->
      <section id="feedback" role="status" aria-live="polite" aria-atomic="true"></section>
    </div>
  
  </main>

  <script>
    // Fonctionnalit√© de barre de progression
    document.addEventListener('DOMContentLoaded', function() {
      const progressBar = document.getElementById('progressFill');
      const formGroups = document.querySelectorAll('.form-group, fieldset');
      const totalSteps = formGroups.length;
      
      function updateProgress() {
        let completedSteps = 0;
        
        formGroups.forEach(group => {
          const inputs = group.querySelectorAll('input, textarea');
          let hasValue = false;
          
          inputs.forEach(input => {
            if (input.type === 'radio' && input.checked) {
              hasValue = true;
            } else if (input.type === 'file' && input.files.length > 0) {
              hasValue = true;
            } else if (input.type === 'text' && input.value.trim()) {
              hasValue = true;
            } else if (input.tagName === 'TEXTAREA' && input.value.trim()) {
              hasValue = true;
            }
          });
          
          if (hasValue) {
            completedSteps++;
          }
        });
        
        const percentage = (completedSteps / totalSteps) * 100;
        progressBar.style.width = percentage + '%';
      }
      
      // √âcouter les changements sur tous les champs
      document.addEventListener('input', updateProgress);
      document.addEventListener('change', updateProgress);
      
      // Mise √† jour initiale
      updateProgress();
    });

    /**
     * G√©n√®re dynamiquement l'option 2 du formulaire avec le mois pr√©c√©dent
     * Utilise les r√®gles de fran√ßais pour les articles ('d'' vs 'de ')
     * Voyelles + 'h' ‚Üí "d'" (ex: "a connu meilleur mois d'octobre")  
     * Consonnes ‚Üí "de " (ex: "a connu meilleur mois de janvier")
     */
    function generateDynamicOption2() {
      const today = new Date();
      const prev = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      
      // Force la locale fran√ßaise pour assurer la coh√©rence
      const month = prev.toLocaleString('fr-FR', { month: 'long' });
      
      // Voyelles fran√ßaises + 'h' muet (r√®gles d'√©lision)
      const vowelsAndH = ['a', 'e', 'i', 'o', 'u', 'h'];
      
      const firstLetter = month[0].toLowerCase();
      const prefix = vowelsAndH.includes(firstLetter)
        ? "a connu meilleur mois d'"
        : 'a connu meilleur mois de ';
      
      return `${prefix}${month}`;
    }

    // Mise √† jour dynamique de l'option 2
    document.addEventListener('DOMContentLoaded', () => {
      const opt2 = document.getElementById('option2');
      const lbl2 = document.getElementById('labelOption2');
      
      if (opt2 && lbl2) {
        const fullText = generateDynamicOption2();
        opt2.value = fullText;
        lbl2.textContent = fullText;
      }
    });

    // Fonction pour afficher/cacher l'√©tat de chargement
    function showLoading(show = true, message = 'Traitement en cours...') {
      let overlay = document.getElementById('loadingOverlay');
      
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.className = 'loading-overlay hidden';
        overlay.innerHTML = `
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">${message}</div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
      
      if (show) {
        overlay.classList.remove('hidden');
        overlay.querySelector('.loading-text').textContent = message;
      } else {
        overlay.classList.add('hidden');
      }
    }

    // Upload et soumission
    document.getElementById('friendForm').addEventListener('submit', async e => {
      e.preventDefault();
      const feedback = document.getElementById('feedback');
      const submitBtn = document.querySelector('button[type="submit"]');
      
      // R√©initialiser l'√©tat
      feedback.textContent = '';
      
      // Afficher √©tat de chargement
      showLoading(true, 'Validation en cours...');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Envoi en cours...';

      // Validation helper function
      function validateField(id, errorMessage, isFile = false) {
        const element = document.getElementById(id);
        const value = isFile ? element.files[0] : element.value.trim();
        if (!value) {
          showLoading(false);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Envoyer le formulaire';
          feedback.textContent = `‚ùå ${errorMessage}`;
          return false;
        }
        return value;
      }

      // Validate radio button
      const q1Radio = document.querySelector('input[name="question1"]:checked');
      if (!q1Radio) {
        showLoading(false);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Envoyer le formulaire';
        feedback.textContent = '‚ùå Veuillez s√©lectionner une r√©ponse √† la premi√®re question';
        return;
      }

      // Validate all fields
      const name = validateField('name', 'Veuillez renseigner votre nom');
      if (!name) return;

      const q1 = q1Radio.value;
      const q2 = validateField('question2', 'Veuillez r√©pondre √† la question 2');
      if (!q2) return;

      const q3File = validateField('question3', 'Veuillez ajouter une photo pour la question 3', true);
      if (!q3File) return;

      const q4 = validateField('question4', 'Veuillez r√©pondre √† la question 4');
      if (!q4) return;

      const q5File = validateField('question5', 'Veuillez ajouter une image pour la question 5', true);
      if (!q5File) return;

      const q6 = validateField('question6', 'Veuillez r√©pondre √† la question 6');
      if (!q6) return;

      const q7File = validateField('question7', 'Veuillez ajouter une image pour la question 7', true);
      if (!q7File) return;

      const q8 = validateField('question8', 'Veuillez r√©pondre √† la question 8');
      if (!q8) return;

      const q9 = validateField('question9', 'Veuillez r√©pondre √† la question 9');
      if (!q9) return;

      const q10File = validateField('question10', 'Veuillez ajouter une photo pour la question 10', true);
      if (!q10File) return;

      async function uploadFile(id) {
        const inp = document.getElementById(id);
        const f = inp.files[0];
        if (!f) return null;
        const fd = new FormData();
        fd.append('image', f);
        const r = await fetch('/api/upload', {
          method: 'POST',
          credentials:'include',
          body: fd
        });
        if (!r.ok) throw new Error(`Upload ${id} ${r.status}`);
        const j = await r.json();
        return j.url;
      }

      try {
        const q3  = await uploadFile('question3');
        const q5  = await uploadFile('question5');
        const q7  = await uploadFile('question7');
        const q10 = await uploadFile('question10');

        const data = {
          name,
          responses: [
            { question: 'En rapide, comment √ßa va ?', answer: q1 },
            { question: 'Possibilit√© d\'ajouter un peu plus de d√©tails √† la question pr√©c√©dente :', answer: q2 },
            { question: 'Le pulse check mensuel... montre une photo de toi ce mois-ci', answer: q3 },
            { question: "Est-ce que tu veux partager un truc cool que t'as fait ce mois-ci ?", answer: q4 },
            { question: "C'est quoi la reaction pic que tu utilises le plus en ce moment ?", answer: q5 },
            { question: "Est-ce que t'as eu une conversation int√©ressante avec quelqu'un r√©cemment ? De quoi est-ce que √ßa parlait ?", answer: q6 },
            { question: "Ta d√©couverte culturelle du moment ? (film, s√©rie, resto, bar, zoo, belle femme, v√™tement... une cat√©gorie assez libre finalement)", answer: q7 },
            { question: "Est-ce que t'as une habitude ou une nouvelle routine que t'essaies d'impl√©menter ces temps-ci ? Si oui... est-ce que √ßa fonctionne... si non... est-ce que y'a un truc que tu voudrais impl√©menter ?", answer: q8 },
            { question: "Appel √† un AMI : Est-ce que t'as un probl√®me particulier pour lequel tu aurais besoin d'opinions tierces ? (exemple : poll pour ta prochaine teinture, recommandations de matelas, etc.)", answer: q9 },
            { question: "Pour terminer : une photo de toi qui touche de l'herbe ou un arbre", answer: q10 }
          ]
        };

        // Mettre √† jour le message de chargement
        showLoading(true, 'Envoi de vos r√©ponses...');

        // Envoi des r√©ponses
        const resp = await fetch('/api/response', {
          method: 'POST',
          credentials:'include',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });

        const resJ = await resp.json();

        if (!resp.ok) {
          throw new Error(resJ.message || 'Erreur lors de l‚Äôenvoi');
        }

        // Affiche le message et le lien de mani√®re s√©curis√©e
        feedback.replaceChildren();
        
        const successIcon = document.createTextNode('‚úÖ ');
        const messageText = document.createTextNode(resJ.message);
        feedback.appendChild(successIcon);
        feedback.appendChild(messageText);
        
        if (resJ.link) {
          const br = document.createElement('br');
          const linkText = document.createTextNode('Votre lien priv√© : ');
          const linkEl = document.createElement('a');
          linkEl.href = resJ.link;
          linkEl.target = '_blank';
          linkEl.textContent = resJ.link;
          
          feedback.appendChild(br);
          feedback.appendChild(linkText);
          feedback.appendChild(linkEl);
        }
      } catch (err) {
        console.error(err);
        feedback.textContent = '‚ùå ' + err.message;
      } finally {
        // Restaurer l'√©tat du bouton et cacher le chargement
        showLoading(false);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Envoyer le formulaire';
      }
    });
  </script>
</body>
</html>
