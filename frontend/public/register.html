<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription - FAF</title>
    <link rel="stylesheet" href="/css/shared-base.css">
    <link rel="stylesheet" href="/css/register.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Cr√©er un compte</h1>
            <p>Rejoignez FAF et sauvegardez vos r√©ponses</p>
        </div>

        <div id="successMessage" class="success-message"></div>

        <form id="registerForm">
            <div class="form-group">
                <label for="username">Nom d'utilisateur</label>
                <input type="text" id="username" name="username" required 
                       placeholder="Ex: john_doe" minlength="3" maxlength="30">
                <div class="error-message" id="usernameError"></div>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required 
                       placeholder="votre@email.com">
                <div class="error-message" id="emailError"></div>
            </div>


            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" name="password" required 
                       placeholder="Au moins 6 caract√®res" minlength="6">
                <div class="password-strength">
                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                </div>
                <div class="error-message" id="passwordError"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmer le mot de passe</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required 
                       placeholder="Retapez votre mot de passe">
                <div class="error-message" id="confirmPasswordError"></div>
            </div>

            <div class="migration-section">
                <h3>üîÑ Migration des donn√©es existantes</h3>
                <p>Si vous avez d√©j√† utilis√© FAF avec des liens priv√©s, vos r√©ponses seront automatiquement associ√©es √† votre nouveau compte lors de votre premi√®re connexion.</p>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                Cr√©er mon compte
            </button>

            <div class="loading" id="loading">
                Cr√©ation du compte en cours...
            </div>
        </form>

        <div class="login-link">
            <p>D√©j√† un compte ? <a href="/login.html">Se connecter</a></p>
        </div>
    </div>

    <script nonce="{{nonce}}">
        // Form validation and submission
        const form = document.getElementById('registerForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');

        // Password strength checker
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('passwordStrengthBar');

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            strengthBar.className = 'password-strength-bar';
            
            if (strength < 30) {
                strengthBar.classList.add('strength-weak');
            } else if (strength < 70) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });

        function calculatePasswordStrength(password) {
            let strength = 0;
            
            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password)) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            
            return strength;
        }

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    successMessage.textContent = 'Compte cr√©√© avec succ√®s ! Redirection vers la connexion...';
                    successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = '/login?registered=1';
                    }, 2000);
                } else {
                    displayErrors(result.errors || [{ msg: result.error || 'Erreur lors de la cr√©ation du compte' }]);
                }
            } catch (error) {
                console.error('Registration error:', error);
                displayErrors([{ msg: 'Erreur r√©seau. Veuillez r√©essayer.' }]);
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        });

        function validateForm() {
            clearErrors();
            let isValid = true;

            // Username validation
            const username = document.getElementById('username').value;
            if (username.length < 3) {
                showError('usernameError', 'Le nom d\'utilisateur doit contenir au moins 3 caract√®res');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                showError('usernameError', 'Le nom d\'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores');
                isValid = false;
            }

            // Email validation
            const email = document.getElementById('email').value;
            if (!isValidEmail(email)) {
                showError('emailError', 'Veuillez entrer un email valide');
                isValid = false;
            }

            // Password validation
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password.length < 6) {
                showError('passwordError', 'Le mot de passe doit contenir au moins 6 caract√®res');
                isValid = false;
            }

            if (password !== confirmPassword) {
                showError('confirmPasswordError', 'Les mots de passe ne correspondent pas');
                isValid = false;
            }


            return isValid;
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
                element.textContent = '';
            });
            successMessage.style.display = 'none';
        }

        function displayErrors(errors) {
            clearErrors();
            
            errors.forEach(error => {
                const field = error.param || 'general';
                const message = error.msg || error.message || 'Erreur inconnue';
                
                switch(field) {
                    case 'username':
                        showError('usernameError', message);
                        break;
                    case 'email':
                        showError('emailError', message);
                        break;
                    case 'password':
                        showError('passwordError', message);
                        break;
                    default:
                        alert(message);
                }
            });
        }

        // Real-time validation
        document.getElementById('username').addEventListener('blur', function() {
            const username = this.value;
            if (username && (username.length < 3 || !/^[a-zA-Z0-9_-]+$/.test(username))) {
                showError('usernameError', 'Nom d\'utilisateur invalide');
            }
        });

        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            if (email && !isValidEmail(email)) {
                showError('emailError', 'Email invalide');
            }
        });

        document.getElementById('confirmPassword').addEventListener('blur', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            if (confirmPassword && password !== confirmPassword) {
                showError('confirmPasswordError', 'Les mots de passe ne correspondent pas');
            }
        });
    </script>
</body>
</html>