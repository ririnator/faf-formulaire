<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Vos réponses</title>
  <link rel="stylesheet" href="/css/view.css">
</head>
<body>
  <h1>Vos réponses – <span id="month"></span></h1>
  <div id="qa-container"></div>

  <script>
    // Fonction pour décoder uniquement les entités HTML sûres (liste blanche)
    function unescapeHTML(text) {
      if (!text || typeof text !== 'string') return text || '';
      
      // Approche liste blanche : décoder uniquement les entités communes et sûres
      const safeEntityMap = {
        '&#x27;': "'",
        '&#39;': "'",
        '&apos;': "'",
        '&quot;': '"',
        '&amp;': '&',
        '&lt;': '<',
        '&gt;': '>',
        '&nbsp;': ' ',
        '&eacute;': 'é',
        '&egrave;': 'è',
        '&ecirc;': 'ê',
        '&agrave;': 'à',
        '&acirc;': 'â',
        '&ugrave;': 'ù',
        '&ucirc;': 'û',
        '&icirc;': 'î',
        '&ocirc;': 'ô',
        '&ccedil;': 'ç'
      };
      
      let result = text;
      for (const [entity, char] of Object.entries(safeEntityMap)) {
        result = result.replace(new RegExp(entity, 'g'), char);
      }
      
      return result;
    }

    (async () => {
      const token = location.pathname.split('/').pop();
      const res = await fetch(`/api/view/${token}`);
      if (!res.ok) {
        document.body.innerHTML = '<p>Lien invalide ou expiré.</p>';
        return;
      }
      const { user, admin } = await res.json();
      document.getElementById('month').textContent = user.month;

      user.responses.forEach((q, i) => {
        const block = document.createElement('div');
        
        // Décoder les entités HTML de manière sécurisée
        const question = unescapeHTML(q.question);
        const answer = unescapeHTML(q.answer);

        // Créer les éléments de manière sécurisée (pas d'innerHTML)
        const questionElement = document.createElement('h2');
        questionElement.textContent = `Q${i+1} : ${question}`;

        const yourAnswer = document.createElement('p');
        yourAnswer.innerHTML = `<strong>Vous :</strong> `;
        yourAnswer.appendChild(document.createTextNode(answer));

        const adminAnswerElement = document.createElement('p');
        adminAnswerElement.className = 'admin-answer';
        adminAnswerElement.innerHTML = `<strong>Moi (Admin) :</strong> `;
        if (admin && admin.responses[i]) {
          const adminAnswerText = unescapeHTML(admin.responses[i].answer);
          adminAnswerElement.appendChild(document.createTextNode(adminAnswerText));
        } else {
          const emElement = document.createElement('em');
          emElement.textContent = 'Pas encore répondu';
          adminAnswerElement.appendChild(emElement);
        }

        block.appendChild(questionElement);
        block.appendChild(yourAnswer);
        block.appendChild(adminAnswerElement);
        document.getElementById('qa-container').append(block);
      });
    })();
  </script>
</body>
</html>