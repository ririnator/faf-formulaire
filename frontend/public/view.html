<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Vos réponses</title>
  <link rel="stylesheet" href="/css/view.css">
</head>
<body>
  <h1>Vos réponses – <span id="month"></span></h1>
  <div id="qa-container"></div>

  <script>
    // Fonction pour décoder uniquement les entités HTML sûres (liste blanche)
    function unescapeHTML(text) {
      if (!text || typeof text !== 'string') return text || '';
      
      // Approche liste blanche : décoder uniquement les entités communes et sûres
      const safeEntityMap = {
        '&#x27;': "'",
        '&#39;': "'",
        '&apos;': "'",
        '&quot;': '"',
        '&amp;': '&',
        '&lt;': '<',
        '&gt;': '>',
        '&nbsp;': ' ',
        '&eacute;': 'é',
        '&egrave;': 'è',
        '&ecirc;': 'ê',
        '&agrave;': 'à',
        '&acirc;': 'â',
        '&ugrave;': 'ù',
        '&ucirc;': 'û',
        '&icirc;': 'î',
        '&ocirc;': 'ô',
        '&ccedil;': 'ç'
      };
      
      let result = text;
      for (const [entity, char] of Object.entries(safeEntityMap)) {
        result = result.replace(new RegExp(entity, 'g'), char);
      }
      
      return result;
    }

    (async () => {
      const token = location.pathname.split('/').pop();
      const res = await fetch(`/api/view/${token}`);
      if (!res.ok) {
        document.body.innerHTML = '<p>Lien invalide ou expiré.</p>';
        return;
      }
      const { user, admin } = await res.json();
      document.getElementById('month').textContent = user.month;

      // Configuration du regroupement des questions
      const questionGroups = [
        { name: "État général du mois", questions: [0, 1] }, // Q1-Q2: Comment ça va + détails
        { name: "Check personnel", questions: [2] }, // Q3: Photo de toi
        { name: "Activités & découvertes", questions: [3, 4, 6] }, // Q4: Truc cool, Q5: Reaction pic, Q7: Découverte culturelle  
        { name: "Réflexions & conversations", questions: [5, 7] }, // Q6: Conversation intéressante, Q8: Habitudes/routines
        { name: "Appel à un ami", questions: [8] }, // Q9: Problème/opinions tierces
        { name: "Connexion à la nature", questions: [9] } // Q10: Photo avec herbe/arbre
      ];

      // Fonction pour détecter et afficher une image Cloudinary
      function createAnswerContent(answer) {
        const container = document.createElement('span');
        
        // Vérifier si c'est une URL d'image (Cloudinary ou autre)
        const imageUrlPattern = /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$|^https:\/\/res\.cloudinary\.com\/.+$/i;
        
        if (imageUrlPattern.test(answer)) {
          const img = document.createElement('img');
          img.src = answer;
          img.alt = 'Image partagée';
          img.style.maxWidth = '300px';
          img.style.maxHeight = '300px'; 
          img.style.borderRadius = '8px';
          img.style.margin = '10px 0';
          img.style.display = 'block';
          
          // Gestion d'erreur si l'image ne charge pas
          img.onerror = function() {
            container.textContent = `Image non disponible: ${answer}`;
          };
          
          container.appendChild(img);
        } else {
          container.textContent = answer;
        }
        
        return container;
      }

      // Affichage par groupes
      questionGroups.forEach(group => {
        const groupBlock = document.createElement('div');
        groupBlock.className = 'question-group';
        groupBlock.style.marginBottom = '30px';
        groupBlock.style.padding = '20px';
        groupBlock.style.border = '2px solid #e3f2fd';
        groupBlock.style.borderRadius = '10px';
        groupBlock.style.backgroundColor = '#f9f9f9';

        const groupTitle = document.createElement('h2');
        groupTitle.textContent = group.name;
        groupTitle.style.color = '#1976d2';
        groupTitle.style.borderBottom = '2px solid #1976d2';
        groupTitle.style.paddingBottom = '10px';
        groupTitle.style.marginBottom = '20px';
        groupBlock.appendChild(groupTitle);

        group.questions.forEach(questionIndex => {
          if (questionIndex < user.responses.length) {
            const q = user.responses[questionIndex];
            const questionDiv = document.createElement('div');
            questionDiv.style.marginBottom = '20px';
            
            // Décoder les entités HTML de manière sécurisée
            const question = unescapeHTML(q.question);
            const answer = unescapeHTML(q.answer);

            // Question
            const questionElement = document.createElement('h3');
            questionElement.textContent = `Q${questionIndex+1}: ${question}`;
            questionElement.style.color = '#333';
            questionElement.style.marginBottom = '10px';

            // Votre réponse
            const yourAnswer = document.createElement('p');
            yourAnswer.innerHTML = `<strong>Vous:</strong> `;
            yourAnswer.appendChild(createAnswerContent(answer));
            yourAnswer.style.marginBottom = '10px';

            // Réponse admin
            const adminAnswerElement = document.createElement('p');
            adminAnswerElement.className = 'admin-answer';
            adminAnswerElement.innerHTML = `<strong>Moi (Admin):</strong> `;
            if (admin && admin.responses[questionIndex]) {
              const adminAnswerText = unescapeHTML(admin.responses[questionIndex].answer);
              adminAnswerElement.appendChild(createAnswerContent(adminAnswerText));
            } else {
              const emElement = document.createElement('em');
              emElement.textContent = 'Pas encore répondu';
              adminAnswerElement.appendChild(emElement);
            }

            questionDiv.appendChild(questionElement);
            questionDiv.appendChild(yourAnswer);
            questionDiv.appendChild(adminAnswerElement);
            groupBlock.appendChild(questionDiv);
          }
        });

        document.getElementById('qa-container').appendChild(groupBlock);
      });
    })();
  </script>
</body>
</html>