<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - FAF Multi-Tenant</title>

  <!-- Tailwind CSS -->
  <script>
    window.process = { env: { NODE_ENV: 'production' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" />

  <style>
    /* Lightbox pour images */
    .lightbox-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .lightbox-overlay img {
      max-width: 90%;
      max-height: 90%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      border-radius: 4px;
    }
    .lightbox-overlay .close-btn {
      position: absolute;
      top: 1rem; right: 1rem;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <h1 class="text-2xl font-bold text-gray-800">FAF Admin</h1>
          <span class="text-gray-400">|</span>
          <span class="text-gray-700">
            Bienvenue, <strong id="adminUsername" class="text-blue-600">...</strong>
          </span>
        </div>

        <nav class="flex gap-3 items-center flex-wrap">
          <button id="myFormBtn"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors font-medium">
            ðŸ“‹ Mon formulaire
          </button>
          <a href="/admin/gestion.html" class="text-blue-600 hover:underline font-medium">
            Gestion avancÃ©e
          </a>
          <button id="logoutBtn"
                  class="text-red-600 hover:text-red-800 font-semibold transition-colors">
            ðŸšª DÃ©connexion
          </button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8">
    <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">RÃ©sumÃ© des rÃ©ponses</h1>

    <!-- Alert Message -->
    <div id="alertMessage" class="hidden mb-6 p-4 rounded-lg" role="alert"></div>

    <!-- Filtre par mois -->
    <div class="mb-6 text-center">
      <label for="monthFilter" class="font-semibold text-gray-700 mr-2">Filtrer par mois :</label>
      <select id="monthFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="" disabled selected>Choisissez un mois</option>
      </select>
    </div>

    <!-- Conteneur des cartes de questions -->
    <div id="summaryContainer">
      <!-- Cartes gÃ©nÃ©rÃ©es dynamiquement -->
    </div>
  </main>

  <!-- Module ES6 -->
  <script type="module">
    import { AdminAPI, Utils, UI, Charts } from '/admin/faf-admin.js';

    const PIE_QUESTION = "En rapide, comment Ã§a va ?";
    let currentAdmin = null;

    // 1. Charger la liste des mois
    async function loadMonths() {
      const data = await AdminAPI.request('/api/admin/dashboard');
      if (!data || !data.months) return [];

      const sel = document.getElementById('monthFilter');

      data.months.forEach(month => {
        const opt = document.createElement('option');
        opt.value = month;
        opt.textContent = Utils.formatMonth(month);
        sel.appendChild(opt);
      });

      return data.months;
    }

    // 2. Charger et afficher le rÃ©sumÃ© pour un mois
    async function loadSummary() {
      const month = document.getElementById('monthFilter').value;
      if (!month) return;

      const data = await AdminAPI.request(`/api/admin/dashboard?month=${month}`);

      if (!data || !data.questionsSummary) {
        UI.showAlert('Aucune donnÃ©e pour ce mois', 'error');
        return;
      }

      displaySummary(data.questionsSummary);
    }

    // 3. Afficher le rÃ©sumÃ© (une carte par question)
    function displaySummary(questionsSummary) {
      const container = document.getElementById('summaryContainer');
      container.innerHTML = '';

      questionsSummary.forEach((q) => {
        const card = createQuestionCard(q);
        container.appendChild(card);
      });
    }

    // 4. CrÃ©er une carte pour une question
    function createQuestionCard({ question, answers }) {
      const card = document.createElement('div');
      card.className = "bg-white shadow rounded-lg p-6 mb-6";

      // Titre de la question
      const title = document.createElement('h2');
      title.className = "text-xl font-bold text-gray-800 mb-4";
      title.textContent = question;
      card.appendChild(title);

      // Si c'est la question du pie, afficher un graphique
      if (question === PIE_QUESTION) {
        const chartData = {};
        answers.forEach(a => {
          chartData[a.answer] = (chartData[a.answer] || 0) + 1;
        });

        const canvas = document.createElement('canvas');
        canvas.style.maxHeight = '320px';
        card.appendChild(canvas);

        // CrÃ©er le graphique
        new Chart(canvas, {
          type: 'pie',
          data: {
            labels: Object.keys(chartData),
            datasets: [{
              data: Object.values(chartData),
              backgroundColor: [
                '#4A90E2', '#50C878', '#FF6B6B', '#FFD93D',
                '#A78BFA', '#F472B6', '#34D399', '#60A5FA'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      } else {
        // Liste des rÃ©ponses
        const list = document.createElement('div');
        list.className = "space-y-3";

        answers.forEach(a => {
          const item = document.createElement('div');
          item.className = "flex items-start gap-3 border-b border-gray-100 pb-3";

          const nameSpan = document.createElement('span');
          nameSpan.className = "font-semibold text-blue-600 min-w-[120px]";
          nameSpan.textContent = a.name + ':';

          const answerSpan = document.createElement('span');
          answerSpan.className = "text-gray-700 flex-1";

          // VÃ©rifier si c'est une image
          if (typeof a.answer === 'string' && a.answer.includes('res.cloudinary.com')) {
            const img = document.createElement('img');
            img.src = a.answer;
            img.alt = 'RÃ©ponse image';
            img.className = 'max-w-xs rounded shadow-md cursor-pointer hover:opacity-90 transition';
            img.onclick = () => openLightbox(a.answer, a.name);
            answerSpan.appendChild(img);
          } else {
            answerSpan.textContent = a.answer;
          }

          item.appendChild(nameSpan);
          item.appendChild(answerSpan);
          list.appendChild(item);
        });

        card.appendChild(list);
      }

      return card;
    }

    // 5. Lightbox pour images
    function openLightbox(url, name) {
      const overlay = document.createElement('div');
      overlay.className = 'lightbox-overlay';

      const closeBtn = document.createElement('span');
      closeBtn.className = 'close-btn';
      closeBtn.textContent = 'Ã—';
      closeBtn.onclick = () => document.body.removeChild(overlay);

      const img = document.createElement('img');
      img.src = url;
      img.alt = name;

      overlay.appendChild(closeBtn);
      overlay.appendChild(img);
      overlay.onclick = (e) => {
        if (e.target === overlay) document.body.removeChild(overlay);
      };

      document.body.appendChild(overlay);
    }

    // 6. Initialisation
    (async () => {
      try {
        // VÃ©rifier l'authentification
        currentAdmin = await AdminAPI.checkAuth();
        if (!currentAdmin) return;

        // Initialiser le header
        UI.initAdminHeader(currentAdmin);

        // Charger les mois
        const months = await loadMonths();

        // SÃ©lectionner le premier mois par dÃ©faut
        if (months.length > 0) {
          document.getElementById('monthFilter').value = months[0];
          await loadSummary();
        }

        // Event listener sur le select
        document.getElementById('monthFilter').addEventListener('change', loadSummary);

      } catch (err) {
        console.error('Erreur initialisation:', err);
        UI.showAlert('Erreur lors du chargement. Veuillez recharger la page.', 'error');
      }
    })();
  </script>

</body>
</html>
