<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bienvenue - FAF</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <div class="onboarding-container">
    <div class="onboarding-box">
      <div class="success-icon-large">✅</div>

      <h1 class="onboarding-title">Félicitations, <span id="username"></span> !</h1>
      <p class="onboarding-subtitle">Votre compte a été créé avec succès.</p>

      <div class="form-link-box">
        <h2>Votre formulaire unique</h2>
        <p class="form-link-description">Partagez ce lien avec vos amis pour qu'ils puissent remplir votre formulaire mensuel</p>
        <div class="link-display">
          <input
            type="text"
            id="formLink"
            readonly
            value=""
          >
          <button id="copyBtn" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            Copier
          </button>
        </div>
        <p class="copy-feedback" id="copyFeedback" style="display:none">
          ✓ Lien copié dans le presse-papiers !
        </p>
      </div>

      <div class="instructions">
        <h2>Prochaines étapes</h2>
        <ol class="steps-list">
          <li>
            <div class="step-number">1</div>
            <div class="step-content">
              <h3>Remplissez votre formulaire</h3>
              <p>Soyez le premier à répondre pour que vos amis puissent se comparer à vous.</p>
              <a href="#" id="fillFormBtn" class="btn btn-primary">Remplir mon formulaire</a>
            </div>
          </li>
          <li>
            <div class="step-number">2</div>
            <div class="step-content">
              <h3>Partagez votre lien</h3>
              <p>Envoyez le lien ci-dessus à vos amis via WhatsApp, email, SMS, etc.</p>
            </div>
          </li>
          <li>
            <div class="step-number">3</div>
            <div class="step-content">
              <h3>Consultez les réponses</h3>
              <p>Dès que vos amis répondent, visualisez leurs réponses dans votre dashboard.</p>
              <a href="/admin/dashboard.html" class="btn btn-secondary">Aller au dashboard</a>
            </div>
          </li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    // Get username and token from localStorage
    const username = localStorage.getItem('faf_username');
    const token = localStorage.getItem('faf_token');

    if (!username || !token) {
      // Redirect to login if no auth found
      window.location.href = '/auth/login.html';
    } else {
      // Check payment status first
      checkPaymentStatus();
    }

    async function checkPaymentStatus() {
      try {
        const response = await fetch(`${window.location.origin}/api/payment/status`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok && data.has_access) {
          // Payment is active, show onboarding
          document.getElementById('username').textContent = username;
          const formLink = `${window.location.origin}/form/${username}`;
          document.getElementById('formLink').value = formLink;
          document.getElementById('fillFormBtn').href = `/form/${username}`;
        } else {
          // No payment, redirect to Stripe checkout
          redirectToCheckout();
        }
      } catch (error) {
        console.error('Error checking payment:', error);
        // On error, try to redirect to checkout
        redirectToCheckout();
      }
    }

    async function redirectToCheckout() {
      try {
        const response = await fetch(`${window.location.origin}/api/payment/create-checkout`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok && data.sessionUrl) {
          // Redirect to Stripe
          window.location.href = data.sessionUrl;
        } else {
          // Fallback to payment-required page
          window.location.href = '/auth/payment-required.html';
        }
      } catch (error) {
        console.error('Error creating checkout session:', error);
        window.location.href = '/auth/payment-required.html';
      }
    }

    // Copy to clipboard functionality
    document.getElementById('copyBtn').addEventListener('click', () => {
      const input = document.getElementById('formLink');
      input.select();
      input.setSelectionRange(0, 99999); // For mobile devices

      try {
        // Modern API
        navigator.clipboard.writeText(input.value).then(() => {
          showCopyFeedback();
        }).catch(() => {
          // Fallback for older browsers
          document.execCommand('copy');
          showCopyFeedback();
        });
      } catch (err) {
        // Fallback for very old browsers
        document.execCommand('copy');
        showCopyFeedback();
      }
    });

    function showCopyFeedback() {
      const feedback = document.getElementById('copyFeedback');
      feedback.style.display = 'block';
      setTimeout(() => {
        feedback.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
