<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste de toutes les r√©ponses</title>
  <script>
    // Suppress Tailwind CDN production warning
    window.process = { env: { NODE_ENV: 'production' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/admin/mobile-responsive.css">
  <script type="module" src="/admin/faf-admin.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" href="/favicon.ico" />
</head>
<body class="bg-gray-50 p-6">
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>

  <div class="container mx-auto">
    <!-- Header avec info admin -->
    <header class="bg-white shadow-md rounded-lg p-4 mb-6">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <div class="flex items-center gap-2">
          <h2 class="text-xl font-bold text-gray-800">
            FAF Admin - Gestion
          </h2>
          <span class="text-gray-600">|</span>
          <span class="text-gray-700">
            Bienvenue, <strong id="adminUsername" class="text-blue-600">...</strong>
          </span>
        </div>

        <nav class="flex gap-3 items-center flex-wrap" role="navigation" aria-label="Navigation administrateur">
          <a href="/admin" class="text-blue-600 hover:underline">‚Üê Retour au r√©sum√©</a>
          <button id="myFormBtn"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors"
                  aria-label="Copier le lien de mon formulaire">
            üìã Mon formulaire
          </button>
          <button id="logoutBtn"
                  class="text-red-600 hover:text-red-800 font-semibold"
                  aria-describedby="logout-help">
            üö™ D√©connexion
          </button>
          <div id="logout-help" class="sr-only">Se d√©connecter de l'interface admin</div>
        </nav>
      </div>
    </header>
    
    <main id="main-content" role="main">
      <h1 class="text-3xl font-bold text-center mb-6">Toutes les r√©ponses re√ßues</h1>

    <!-- Message d'erreur/succ√®s -->
    <div id="alertMessage" class="hidden mb-4 p-4 rounded-lg" 
         role="alert" aria-live="assertive"></div>

    <!-- Search et Filter Section -->
    <div class="mb-6 flex gap-4" role="search">
      <div class="flex-1">
        <label for="searchInput" class="sr-only">Rechercher par nom</label>
        <input type="text" id="searchInput" placeholder="Rechercher par nom..."
               class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               aria-describedby="search-help">
        <div id="search-help" class="sr-only">Tapez un nom pour filtrer les r√©ponses</div>
      </div>
      <div>
        <label for="sortSelect" class="sr-only">Trier par</label>
        <select id="sortSelect" class="px-4 py-2 border rounded-lg"
                aria-describedby="sort-help">
          <option value="newest">Plus r√©centes</option>
          <option value="oldest">Plus anciennes</option>
        </select>
        <div id="sort-help" class="sr-only">Choisir l'ordre de tri des r√©ponses</div>
      </div>
    </div>

    <!-- Conteneur du tableau -->
    <div class="table-container overflow-x-auto">
      <table class="min-w-full bg-white border table-fixed" role="table" aria-label="Liste des r√©ponses re√ßues">
        <thead>
          <tr>
            <th class="w-1/4 py-2 px-4 border-b text-left" scope="col">Date</th>
            <th class="w-2/4 py-2 px-4 border-b text-center" scope="col">Nom</th>
            <th class="w-1/4 py-2 px-4 border-b text-right" scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="responsesTableBody"></tbody>
      </table>

      <!-- Pagination Controls -->
      <nav class="pagination-controls mt-4 flex items-center space-x-4" 
           role="navigation" aria-label="Pagination des r√©ponses">
        <button id="prevBtn" class="px-3 py-1 border rounded" 
                aria-describedby="prev-help">Pr√©c√©dent</button>
        <div id="prev-help" class="sr-only">Aller √† la page pr√©c√©dente</div>
        
        <span aria-live="polite">
          Page <strong id="currentPage">1</strong> / <strong id="totalPages">1</strong>
        </span>
        
        <button id="nextBtn" class="px-3 py-1 border rounded"
                aria-describedby="next-help">Suivant</button>
        <div id="next-help" class="sr-only">Aller √† la page suivante</div>
      </nav>
    </div>

    <!-- Modal de d√©tails -->
    <div id="detailsModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
         role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="bg-white p-6 rounded-lg w-1/2" role="document">
        <h2 id="modal-title" class="text-2xl font-semibold mb-4">D√©tails de la r√©ponse</h2>
        <div id="responseDetails" aria-live="polite"></div>
        <button id="closeDetails" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                aria-describedby="close-help">Fermer</button>
        <div id="close-help" class="sr-only">Fermer la fen√™tre de d√©tails</div>
      </div>
    </div>
    
    </main>
  </div>

  <script type="module">
    import { AdminAPI, Utils, UI } from '/admin/faf-admin.js';

    let currentPage = 1;
    const limit = 10;
    let allResponses = [];

    // Fonction d'alerte simplifi√©e utilisant le module FAF
    function safeAlert(message, type = 'error') {
      UI.showAlert(message, type);
    }

    // Charge une page donn√©e avec gestion d'erreur am√©lior√©e
    async function loadPage(page = 1) {
      const data = await AdminAPI.request(
        `/api/admin/responses?page=${page}&limit=${limit}`,
        {},
        'Impossible de charger les donn√©es'
      );
      
      if (!data) return;
      
      const { responses, pagination } = data;
      
      allResponses = responses;
      renderTable(responses);

      currentPage = pagination.page;
      document.getElementById('currentPage').textContent = pagination.page;
      document.getElementById('totalPages').textContent = pagination.totalPages;

      document.getElementById('prevBtn').disabled = pagination.page <= 1;
      document.getElementById('nextBtn').disabled = pagination.page >= pagination.totalPages;
    }

    // Cr√©e dynamiquement le <tbody> du tableau
    function renderTable(docs) {
      const tbody = document.getElementById('responsesTableBody');
      tbody.replaceChildren(); // r√©initialise

      docs.forEach(doc => {
        const tr = document.createElement('tr');

        // Si c'est la r√©ponse admin, on la surligne
        if (doc.isAdmin) {
          tr.classList.add('bg-red-100', 'border-l-4', 'border-red-500');
        }

        // Date
        const dateTd = document.createElement('td');
        dateTd.className = "py-2 px-4 border-b text-left";
        dateTd.textContent = Utils.formatDate(doc.createdAt);
        tr.appendChild(dateTd);

        // Nom (on ajoute "(Admin)" si n√©cessaire)
        const nameTd = document.createElement('td');
        nameTd.className = "py-2 px-4 border-b text-center";
        nameTd.textContent = doc.name + (doc.isAdmin ? ' (Admin)' : '');
        tr.appendChild(nameTd);

        // Actions : bouton Supprimer et (√©ventuellement) Voir
        const actionTd = document.createElement('td');
        actionTd.className = "py-2 px-4 border-b text-right flex justify-end space-x-2";

        // Bouton Voir (si token pr√©sent)
        if (doc.token) {
          const viewBtn = document.createElement('a');
          viewBtn.href = `/view/${doc.token}`;
          viewBtn.target = '_blank';
          viewBtn.className = "bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600";
          viewBtn.textContent = 'Voir';
          actionTd.appendChild(viewBtn);
        }

        // Bouton Supprimer
        const delBtn = document.createElement('button');
        delBtn.className = "bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600";
        delBtn.textContent = 'Supprimer';
        delBtn.addEventListener('click', async () => {
          if (!confirm(`Supprimer la r√©ponse de ${doc.name} du ${Utils.formatDate(doc.createdAt).split(' ')[0]} ?`)) {
            return;
          }
          
          const result = await AdminAPI.request(
            `/api/admin/responses/${doc._id}`, 
            { method: 'DELETE' },
            'Erreur lors de la suppression'
          );
          
          if (result) {
            safeAlert(`R√©ponse de ${doc.name} supprim√©e avec succ√®s`, 'success');
            
            // Logique de pagination am√©lior√©e
            // D'abord recharger la page courante pour voir s'il reste des √©l√©ments
            const remainingResponses = allResponses.filter(r => r._id !== doc._id);
            
            if (remainingResponses.length === 0 && currentPage > 1) {
              // Si plus rien sur cette page et on n'est pas sur la page 1, aller √† la pr√©c√©dente
              loadPage(currentPage - 1);
            } else {
              // Sinon recharger la page courante
              loadPage(currentPage);
            }
          }
        });
        actionTd.appendChild(delBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
    }

    // Pagination
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) loadPage(currentPage - 1);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      loadPage(currentPage + 1);
    });

    // Recherche globale avec debounce am√©lior√©
    const debouncedSearch = (typeof debounce !== 'undefined' ? debounce : (fn, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    })(async (term) => {
      if (term === '') {
        // Si pas de terme, recharger la page courante
        loadPage(currentPage);
        return;
      }
      
      // Recherche globale sur toutes les donn√©es
      const data = await AdminAPI.request(
        `/api/admin/responses?search=${encodeURIComponent(term)}&limit=100`,
        {},
        'Erreur lors de la recherche'
      );
      
      if (data) {
        allResponses = data.responses;
        renderTable(data.responses);
        
        // D√©sactiver pagination pendant recherche
        document.getElementById('prevBtn').disabled = true;
        document.getElementById('nextBtn').disabled = true;
        document.getElementById('currentPage').textContent = 1;
        document.getElementById('totalPages').textContent = 1;
        
        if (data.responses.length === 0) {
          safeAlert('Aucun r√©sultat trouv√© pour cette recherche', 'error');
        }
      }
    }, 300);
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase().trim();
      debouncedSearch(term);
    });

    // Tri par date
    document.getElementById('sortSelect').addEventListener('change', (e) => {
      const order = e.target.value;
      const sorted = [...allResponses].sort((a, b) => {
        const da = new Date(a.createdAt);
        const db = new Date(b.createdAt);
        return order === 'newest' ? db - da : da - db;
      });
      renderTable(sorted);
    });

    // Gestion du header admin
    function initAdminHeader(admin) {
      // Afficher le username
      const usernameEl = document.getElementById('adminUsername');
      if (usernameEl) {
        usernameEl.textContent = admin.username;
      }

      // Bouton "Mon formulaire" - copie le lien
      const myFormBtn = document.getElementById('myFormBtn');
      if (myFormBtn) {
        myFormBtn.addEventListener('click', () => {
          const formLink = `${window.location.origin}/form/${admin.username}`;
          navigator.clipboard.writeText(formLink)
            .then(() => {
              UI.showAlert('Lien copi√© dans le presse-papier ! üìã', 'success');
            })
            .catch((err) => {
              console.error('Erreur copie:', err);
              // Fallback pour les navigateurs anciens
              const textarea = document.createElement('textarea');
              textarea.value = formLink;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              try {
                document.execCommand('copy');
                UI.showAlert('Lien copi√© dans le presse-papier ! üìã', 'success');
              } catch (e) {
                UI.showAlert('Impossible de copier le lien automatiquement', 'error');
              }
              document.body.removeChild(textarea);
            });
        });
      }

      // Bouton d√©connexion
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          AdminAPI.logout();
        });
      }
    }

    // Initialisation avec chargement asynchrone des utilitaires
    (async () => {
      try {
        // 1. V√©rifier l'authentification JWT
        const admin = await AdminAPI.checkAuth();
        if (!admin) {
          // La redirection est g√©r√©e par checkAuth()
          return;
        }

        // 2. Initialiser le header avec les infos admin
        initAdminHeader(admin);

        // 3. Initialiser l'API FAF (CSRF token)
        await AdminAPI.init();

        // 4. Charger la premi√®re page
        await loadPage(1);
      } catch (err) {
        console.error('Initialisation admin_gestion.html :', err);
        safeAlert('Erreur lors du chargement de l\'interface. Veuillez recharger la page.', 'error');
      }
    })();
  </script>
</body>
</html>
