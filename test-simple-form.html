<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Soumission Formulaire FAF</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; }
    .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    .info { background-color: #e3f2fd; border-color: #bbdefb; }
    button { padding: 10px 20px; margin: 10px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
  </style>
</head>
<body>
  <h1>🧪 Test de Soumission du Formulaire FAF</h1>
  
  <div class="test-section info">
    <h2>📋 Instructions de Test</h2>
    <p>Cette page permet de tester la soumission du formulaire sans serveur backend complet.</p>
    <p><strong>État du serveur:</strong> <span id="server-status">❓ Vérification...</span></p>
  </div>

  <div class="test-section">
    <h2>🎯 Test 1: Validation Côté Client</h2>
    <p>Test des validations avant soumission (nom vide, radio non sélectionné, etc.)</p>
    
    <form id="testForm1">
      <input type="text" name="website" style="display:none" tabindex="-1" autocomplete="off">
      
      <div>
        <label for="testName">Nom:</label>
        <input type="text" id="testName" name="name" placeholder="Laissez vide pour tester la validation">
      </div>
      
      <div>
        <label>Comment ça va ?</label>
        <input type="radio" name="question1" id="testOp1" value="ça va"> <label for="testOp1">ça va</label>
        <input type="radio" name="question1" id="testOp2" value="génial"> <label for="testOp2">génial</label>
      </div>
      
      <div>
        <label for="testQ2">Détails:</label>
        <input type="text" id="testQ2" name="question2" placeholder="Réponse optionnelle">
      </div>
      
      <button type="button" onclick="testValidation()">🧪 Tester Validation</button>
    </form>
    
    <div id="validationResult"></div>
  </div>

  <div class="test-section">
    <h2>🌐 Test 2: Soumission API</h2>
    <p>Test de soumission vers l'API backend</p>
    
    <form id="testForm2">
      <div>
        <label for="apiName">Nom:</label>
        <input type="text" id="apiName" name="name" value="Test User" required>
      </div>
      
      <div>
        <label>Comment ça va ?</label>
        <input type="radio" name="question1" id="apiOp1" value="ça va" checked> <label for="apiOp1">ça va</label>
        <input type="radio" name="question1" id="apiOp2" value="génial"> <label for="apiOp2">génial</label>
      </div>
      
      <div>
        <label for="apiQ2">Détails:</label>
        <input type="text" id="apiQ2" name="question2" value="Test de soumission via API" required>
      </div>
      
      <button type="button" onclick="testAPISubmission()">🚀 Tester API</button>
    </form>
    
    <div id="apiResult"></div>
  </div>

  <div class="test-section">
    <h2>📁 Test 3: Upload de Fichiers</h2>
    <p>Test de l'upload d'images (mock)</p>
    
    <div>
      <label for="testFile">Sélectionner une image:</label>
      <input type="file" id="testFile" accept="image/*">
      <button type="button" onclick="testFileUpload()">📎 Tester Upload</button>
    </div>
    
    <div id="uploadResult"></div>
  </div>

  <div class="test-section">
    <h2>📊 Logs de Test</h2>
    <pre id="testLogs">Logs d'activité apparaîtront ici...\n</pre>
    <button onclick="clearLogs()">🗑️ Vider les logs</button>
  </div>

  <script>
    let logArea = document.getElementById('testLogs');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
      logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }
    
    function clearLogs() {
      logArea.textContent = '';
    }
    
    // Test de la validation côté client
    function testValidation() {
      log('🧪 Début du test de validation');
      
      const name = document.getElementById('testName').value.trim();
      const radio = document.querySelector('input[name="question1"]:checked');
      const q2 = document.getElementById('testQ2').value.trim();
      
      let errors = [];
      
      if (!name) errors.push('Nom manquant');
      if (name && name.length < 2) errors.push('Nom trop court (< 2 caractères)');
      if (!radio) errors.push('Aucune option sélectionnée');
      
      const resultDiv = document.getElementById('validationResult');
      
      if (errors.length > 0) {
        resultDiv.innerHTML = `<div class="error"><strong>❌ Erreurs de validation:</strong><ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
        log(`Validation échouée: ${errors.join(', ')}`, 'error');
      } else {
        resultDiv.innerHTML = `<div class="success"><strong>✅ Validation réussie!</strong><br>Nom: "${name}"<br>Réponse: "${radio.value}"<br>Détails: "${q2}"</div>`;
        log(`Validation réussie pour "${name}"`, 'success');
      }
    }
    
    // Test de soumission API
    async function testAPISubmission() {
      log('🚀 Début du test API');
      
      const name = document.getElementById('apiName').value;
      const radio = document.querySelector('input[name="question1"]:checked');
      const q2 = document.getElementById('apiQ2').value;
      
      const data = {
        name: name,
        responses: [
          { question: 'En rapide, comment ça va ?', answer: radio ? radio.value : '' },
          { question: 'Détails supplémentaires', answer: q2 }
        ]
      };
      
      log(`Envoi vers /api/response: ${JSON.stringify(data)}`);
      
      try {
        const response = await fetch('/api/response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        const resultDiv = document.getElementById('apiResult');
        
        if (response.ok) {
          resultDiv.innerHTML = `<div class="success"><strong>✅ Soumission réussie!</strong><br>Message: ${result.message}<br>Lien: ${result.link || 'Aucun'}</div>`;
          log(`API Success: ${result.message}`, 'success');
        } else {
          resultDiv.innerHTML = `<div class="error"><strong>❌ Erreur API (${response.status}):</strong><br>${result.message}</div>`;
          log(`API Error ${response.status}: ${result.message}`, 'error');
        }
        
      } catch (error) {
        document.getElementById('apiResult').innerHTML = `<div class="error"><strong>❌ Erreur réseau:</strong><br>${error.message}</div>`;
        log(`Erreur réseau: ${error.message}`, 'error');
      }
    }
    
    // Test d'upload de fichiers (mock)
    async function testFileUpload() {
      log('📎 Début du test upload');
      
      const fileInput = document.getElementById('testFile');
      const file = fileInput.files[0];
      
      if (!file) {
        document.getElementById('uploadResult').innerHTML = `<div class="error"><strong>❌ Aucun fichier sélectionné</strong></div>`;
        log('Upload échoué: aucun fichier', 'error');
        return;
      }
      
      log(`Fichier sélectionné: ${file.name} (${file.size} bytes, ${file.type})`);
      
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        const resultDiv = document.getElementById('uploadResult');
        
        if (response.ok) {
          resultDiv.innerHTML = `<div class="success"><strong>✅ Upload réussi!</strong><br>URL: ${result.url}</div>`;
          log(`Upload réussi: ${result.url}`, 'success');
        } else {
          resultDiv.innerHTML = `<div class="error"><strong>❌ Erreur upload (${response.status}):</strong><br>${result.error || result.message}</div>`;
          log(`Upload Error ${response.status}: ${result.error || result.message}`, 'error');
        }
        
      } catch (error) {
        document.getElementById('uploadResult').innerHTML = `<div class="error"><strong>❌ Erreur réseau:</strong><br>${error.message}</div>`;
        log(`Erreur upload: ${error.message}`, 'error');
      }
    }
    
    // Vérification du statut du serveur
    async function checkServerStatus() {
      try {
        const response = await fetch('/api/response', { method: 'HEAD' });
        document.getElementById('server-status').innerHTML = '✅ Serveur accessible';
        log('Serveur backend accessible', 'success');
      } catch (error) {
        document.getElementById('server-status').innerHTML = '❌ Serveur inaccessible';
        log('Serveur backend inaccessible - tests API désactivés', 'error');
      }
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      log('🏁 Page de test initialisée');
      checkServerStatus();
    });
  </script>
</body>
</html>